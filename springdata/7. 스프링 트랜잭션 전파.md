# 스프링 트랜잭션 전파

## 기본
트랜잭션을 각각 사용하는 것이 아니라, 트랜잭션이 이미 진행중인데, 여기에 추가로 트랜잭션을 수행할 경우
- 기존 트랜잭션과 별도의 트랜잭션으로 진행
- 기존 트랜잭션을 그대로 이어 받아 진행
위 둘을 결정하는 것이 트랜잭션 전파(propagation)

### 외부 트랜잭션이 수행 중인데, 내부 트랜잭션이 추가로 수행
- 외부 트랜잭션과 내부 트랜잭션을 묶어서 하나의 트랜잭션을 만들어 줌
  - 내부 트랜잭션이 외부 트랜잭션에 참여(기본 동작)
### 물리 트랜잭션, 논리 트랜잭션
- 물리 트랜잭션 : 실제 데이터베이스에 적용되는 트랜잭션
- 논리 트랜잭션 : 트랜잭션 매니저를 통해 트랜잭션을 사용하는 단위
    - 트랜잭션이 진행되는 중에 내부에 추가로 트랜잭션을 사용하는 경우에 나타남(`REQUIRED` 전파 옵션 사용하는 경우)
#### 원칙(REQUIRED)
- 모든 논리 트랜잭션이 커밋돼야 물리 트랜잭션이 커밋됨
- 하나의 논리 트랜잭션이라도 롤백되면 물리 트랜잭션은 롤백

### 트랜잭션 참여

- 내부 트랜잭션이 외부 트랜잭션을 그대로 이어 받아서 따름.
- 외부 트랜젝션의 범위가 내부 트랜잭션까지 넓어진다는 뜻.

=> 외부 트랜잭션과 내부 트랜잭션이 하나의 물리 트랜잭션으로 묶임.

- 내부 트랜잭션은 이미 진행중인 외부 트랜잭션이 참여하는 것이므로, 신규 트랜잭션이 아님.

## 커밋 
- 내부 트랜잭션을 시작하거 커밋할 때, db 커넥션을 통해 커밋하는 로그를 전혀 확인할 수 없음
  - 내부 트랜잭션이 실제 물리 트랜잭션을 커밋하면 트랜잭션이 끝나기 때문에, 외부 트랜잭션까지 이어 나갈 수 없음
  - 따라서, 내부 트랜잭션은 db 커넥션을 통해 물리 트랜잭션을 커밋하면 안됨
- 스프링은 처음 트랜잭션을 시작한 외부 트랜잭션이 실제 물리 트랜잭션을 관리하도록 함.

> 트랜잭션 매니저에 커밋을 호출한다고 해서 항상 실제 커넥션에 물리 커밋이 발생하지 않음.
>
> 신규 트랜잭션인 경우에만 실제 커넥션을 사용해서 물리 커밋과 롤백을 수행.

## 롤백
### 외부 트랜잭션 롤백

- 내부 트랜잭션은 직접 물리 트랜잭션에 관여하지 않기 때문에 외부에서 시작한 물리 트랜잭션 범위가 내부 트랜잭션까지 적용.
    - 전체 롤백이 됨.
### 내부 트랜잭션 롤백
- 내부 트랜잭션을 롤백하면 물리 트랜잭션은 롤백하지 않음
- 기존 트랜잭션을 롤백 전용 표시.
    - `rollbackOnly=true`

- 외부 트랜잭션에서는 롤백 전용 표시가 있는지 확인하고,
    -  있다면 롤백하고 예외를 던짐.
    - `UnexpectedRollbackException` 런타임 예외

#### 참고
롤백된 내부 트랜잭션을 서비스 단에서 잡아 처리하여 흐름을 정상화 한다고 해서 커밋이 되는 것이 아님
- 물리 트랜잭션은 `rollbackOnly`를 참고하여 롤백, 커밋을 정하기 때문에, 이미 내부 트랜잭션에서 롤백이 일어 났다면 true로 설정되어 물리적 커밋이 일어나지 않음.

## REQUIRES_NEW
외부 트랜잭션과 내부 트랜잭션을 분리
- 외부 트랜잭션과 내부 트랜잭션이 각각 별도의 물리 트랜잭션을 가짐.
- db 커넥션을 따로 사용!
> Requires_New를 사용하면 데이터베이스 커넥션이 동시에 2개 사용 -> 커넥션 풀 빨리 소모, 느려질 수 있음.
> isolation, timeout, readonly 등의 트랜잭션 옵션은 제일 처음의 것만 따름. 내부 트랜잭션은 설정해도 안 통함.

#### 예시
로그를 따로 기록하는 레포지토리가 있다고 할때, 로그 리포지토리에서 예외가 발생한다고 해서 비지니스 전체의 트랜잭션이 롤백되면 안됨.



